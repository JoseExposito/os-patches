Description: Allow volume to bet set above 100%.
 Some systems have low maximum volume set (like x220), allow, from an option
 in gnome-control-center to set it above that 100% limit.
 Modified from original patch in ubuntu-settings-daemon from Lars Uebernickel.
Origin: ubuntu
Bug-Ubuntu: https://launchpad.net/bugs/1706524
Bug: https://bugzilla.gnome.org/show_bug.cgi?id=710424
---
 plugins/media-keys/gsd-media-keys-manager.c |   27 ++++++++++++++++++++++++---
 1 file changed, 24 insertions(+), 3 deletions(-)

--- a/plugins/media-keys/gsd-media-keys-manager.c
+++ b/plugins/media-keys/gsd-media-keys-manager.c
@@ -167,6 +167,7 @@ struct GsdMediaKeysManagerPrivate
 
         GSettings       *settings;
         GHashTable      *custom_settings;
+        GSettings       *sound_settings;
 
         GPtrArray       *keys;
 
@@ -1146,6 +1147,18 @@ ensure_canberra (GsdMediaKeysManager *ma
 	if (manager->priv->ca != NULL)
 		return;
 
+        if (strstr (g_getenv("XDG_CURRENT_DESKTOP"), "ubuntu") != NULL) {
+                GSettingsSchema *schema;
+                schema = g_settings_schema_source_lookup(g_settings_schema_source_get_default(),
+                                                         "com.ubuntu.sound", TRUE);
+
+                if (schema != NULL)
+                {
+                        manager->priv->sound_settings = g_settings_new_full(schema, NULL, NULL);
+                        g_settings_schema_unref(schema);
+                }
+        }
+
         ca_context_create (&manager->priv->ca);
         ca_context_set_driver (manager->priv->ca, "pulse");
         ca_context_change_props (manager->priv->ca, 0,
@@ -1166,6 +1179,7 @@ update_dialog (GsdMediaKeysManager *mana
                guint                vol,
                gboolean             muted,
                gboolean             sound_changed,
+               pa_volume_t          max_volume,
                gboolean             quiet)
 {
         GvcMixerUIDevice *device;
@@ -1173,7 +1187,7 @@ update_dialog (GsdMediaKeysManager *mana
         const char *icon;
 
         if (!muted) {
-                vol = (int) (100 * (double) vol / PA_VOLUME_NORM);
+                vol = (int) (100 * (double) vol / max_volume);
                 vol = CLAMP (vol, 0, 100);
         } else {
                 vol = 0.0;
@@ -1329,6 +1343,7 @@ do_sound_action (GsdMediaKeysManager *ma
         gboolean old_muted, new_muted;
         guint old_vol, new_vol, norm_vol_step;
         gboolean sound_changed;
+        pa_volume_t max_volume;
 
         /* Find the stream that corresponds to the device, if any */
         stream = NULL;
@@ -1348,6 +1363,11 @@ do_sound_action (GsdMediaKeysManager *ma
         if (stream == NULL)
                 return;
 
+        if ((manager->priv->sound_settings != NULL) && g_settings_get_boolean (manager->priv->sound_settings, "allow-amplified-volume"))
+                max_volume = PA_VOLUME_UI_MAX;
+        else
+                max_volume = PA_VOLUME_NORM;
+
         if (flags & SOUND_ACTION_FLAG_IS_PRECISE)
                 norm_vol_step = PA_VOLUME_NORM * VOLUME_STEP_PRECISE / 100;
         else
@@ -1374,7 +1394,7 @@ do_sound_action (GsdMediaKeysManager *ma
                 new_muted = FALSE;
                 /* When coming out of mute only increase the volume if it was 0 */
                 if (!old_muted || old_vol == 0)
-                        new_vol = MIN (old_vol + norm_vol_step, MAX_VOLUME);
+                        new_vol = MIN (old_vol + norm_vol_step, max_volume);
                 break;
         }
 
@@ -1391,7 +1411,7 @@ do_sound_action (GsdMediaKeysManager *ma
         }
 
         update_dialog (manager, stream, new_vol, new_muted, sound_changed,
-                       flags & SOUND_ACTION_FLAG_IS_QUIET);
+                       max_volume, flags & SOUND_ACTION_FLAG_IS_QUIET);
 }
 
 static void
@@ -2963,6 +2983,7 @@ gsd_media_keys_manager_stop (GsdMediaKey
         g_clear_object (&priv->power_proxy);
         g_clear_object (&priv->power_screen_proxy);
         g_clear_object (&priv->power_keyboard_proxy);
+        g_clear_object (&priv->sound_settings);
         g_clear_object (&priv->composite_device);
         g_clear_object (&priv->mpris_controller);
         g_clear_object (&priv->screencast_proxy);
